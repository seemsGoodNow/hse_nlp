## Сервис для извлечения юридических ссылок из текста

***[❗❗❗ ОЧЕНЬ СЕКРЕТНАЯ ССЫЛКА на диалог С DeepSeek, на котором обучались авторы ❗❗❗](https://chat.deepseek.com/share/s518yo9t8tfh3g18kq)***

## Придумали и разработали:

- Ткалич Леонид
- Шамшединов Илья
- Шумилин Андрей
- Шурыгин Всеволод

### Идейная реализация:

1. С помощью `pymorphy3` все слова из входного текста нормализуются (`src.law_link_parser.normalize_input_text`). Также с его же помощью нормализуется и создается маппинг "нормализованный закон -> law_id".
2. На нормализованный входной текст натравливаются регулярки (`src.law_link_parser.extract_raw_links`).. Всего реализовано 5 паттернов:
```python
patterns = {
    'article': r'(?:ст\.|статья|в статья)\s*(\d+[\.\d]*)\s*',
    'law_source': r'(.*?)(?=\s*(?:ст\.|статья|п\.|пп\.|подпункт|в статья|$))',
    'point_article': r'в*\s*(?:\sп\.|пункт|пунт|часть)\s*([\.\dа-я]+),*\s*',
    # Pattern to identify many points
    'many_point_article': r'\s*(?:пункт|п\.)\s*((?:[а-яa-z]|\d+[\.\d]*)(?:\s*,\s*(?:[а-яa-z]|\d+[\.\d]*))*(?:\s*и\s*(?:[а-яa-z]|\d+[\.\d]*))?)\s*',
    'subpoint_article': r'\s*(?:пп\.|подпункт)\s*([\.\d]+)',
    # Pattern to identify many subpoints
    'many_subpoint_article': r'(?:подпункт|пп\.)\s*([а-яa-z\d](?:\s*,\s*[а-яa-z\d])*(?:\s*и\s*[а-яa-z\d])?)'
}
```
Далее эти 5 паттернов комбинируются несколькими способами, каждый способ представлен tuple-ом. Например, `('article', 'law_source')` - применить паттерн вида `re.compile(patterns['article'] + patterns['law_source'])`:

```python
patterns_combinations = [
    ('many_subpoint_article', 'point_article', 'article', 'law_source'),
    ('many_subpoint_article', 'many_point_article', 'article', 'law_source'),
    ('subpoint_article', 'point_article', 'article', 'law_source'),
    ('point_article', 'article', 'law_source'),
    ('article', 'law_source'),
    ('point_article', 'law_source'),
]
```
3. Полученные на каждом этапе наборы строк добавляются в общий набор найденных строк - список из объектов `RawLawLink`, при этом отслеживаются дубли.
4. `RawLawLink` содержит сырые ссылки (например, хранит подпункты в виде `а, б и с`, а кодексы как "Название кодекса" + "сырая часть строки"). Эти сырые ссылки обрабатываются (`src.law_link_parser.process_raw_links`), каждому пункту и подпункту создается отдельный `LawLink`, а кодексы подбираются при помощи заранее подготовленного маппинга "нормализованный закон -> law_id".
5. На выходе выдаются только те `LawLink`, для которых был найден `law_id`.

---

## Быстрый старт

Сервис поднимается на порте 8978 в докере.

Чтобы локально запустить сервис нужно воспользоваться командой 
```bash 
python main.py
```

Или

```bash
uvicorn main:app --host 0.0.0.0 --port 8978 --reload
```

### Дебаг

Для дебага сервиса откройте в браузере страницу http://localhost:8978/docs, в которой вам доступен интерфейс Swagger, позволяющий через веб интерфейс тестировать функцию `/detect`.

### Сборка docker-образа

```bash
# Сборка образа
docker build -t law-links-service .

# Запуск контейнера
docker run -d -p 8978:8978 --name law-links-container law-links-service

# Тестирование в терминале
curl -X POST "http://localhost:8978/detect" \
     -H "Content-Type: application/json" \
     -d '{"text": "Согласно статье 23 Налогового кодекса и ст. 145 Гражданского кодекса"}'
```

### Остановка и очистка

```bash
# Остановка контейнера
docker stop law-links-container

# Удаление контейнера и образа
docker rm law-links-container
docker rmi law-links-service
```

---

## Структура проекта

- [`main.py`](https://github.com/seemsGoodNow/hse_nlp/blob/main/main.py) - FastAPI-сервис
- [`src/`](https://github.com/seemsGoodNow/hse_nlp/blob/main/src/) - код проекта
    - [`models/`](https://github.com/seemsGoodNow/hse_nlp/blob/main/src/models) - data-модели для запросов
    - [`law_link_parser/`](https://github.com/seemsGoodNow/hse_nlp/blob/main/src/law_link_parser.py) - функции для парсинга, вызываемые в main.py
- [`data/`](https://github.com/seemsGoodNow/hse_nlp/blob/main/data/) - директория с данными:
    - [`law_aliases.json`](https://github.com/seemsGoodNow/hse_nlp/blob/main/data/law_aliases.json) - исходный маппинг law_id -> названия
    - [`law_alias_to_id.json`](https://github.com/seemsGoodNow/hse_nlp/blob/main/data/law_alias_to_id.json) - модифицированный обратный маппинг вида "название, где каждое слово в нормальной форме" -> law_id

---

## Описание задания

1. Разработать FastAPI сервис, принимающий на вход текст, выделяющий из него юридические ссылки и возвращающий эти ссылки в ввиде объекта:
```json
{
    "links": [
        {
            "law_id":1,
            "article": "12",
            "point_article": "1",
            "subpoint_article": "б"
        },
        ...
    ]
}
```
Сервис принимает на вход JSON вида:
```json
{
    "text": "Пример"
}
```

2. Обернуть сервис в Docker, обеспечив доступность сервиса по адресу `http://localhost:8978/detect`

### Пояснения
#### Что такое юридическая ссылка
Под юридической ссылкой понимают указатель на конкретную юридическую норму.
С помощью этого указателя возможно добраться до небольшой выписки из всего закона.
Например, в тексте:
```text
В соответствии с пп. 1 п. 1 ст. 374 НК РФ объектами налогообложения...
```
юридической ссылкой является подстрока `пп. 1 п. 1 ст. 374 НК РФ`.

Сама ссылка указывает что для обращения к оригинального текста нужно открыть Налоговый Кодекс, найти в нём статью 374, в ней найти первый пункт и первый подпункт в пункте.

Принятой практикой является написание указателя в обратной иерархической последовательности:
подпункт -> пункт | часть -> статья -> название закона/документа

Название закона должно быть записано в поле law_id, статья article, пункт/часть point_article, подпункт subpoint_article
При этом всё кроме названия закона должно быть спаршено в строку, примеры:  
12  
4.6  
а  
43.2-6  
1, 2, 3  
5 и 6  
а также возможные комбинации этих написаний.

Ниже приведет пример текста, который будет подаваться в сервис

```python
test_text = """
В соответствии с пп. 1 п. 1 ст. 374 НК РФ объектами налогообложения признается недвижимое имущество, 
учитываемое на балансе организации в качестве объектов основных средств в порядке, установленном для ст. 105 УК РФ и ведения бухгалтерского учета, в случае, если налоговая база в отношении такого имущества определяется как его среднегодовая стоимость. Согласно п.  10 АПК для целей бухгалтерского учета по общему правилу единицей учета основных средств является инвентарный объект.

Согласно статье 17 Конституции Российской Федерации, каждый гражданин имеет право на жизнь и свободу. Однако, в соответствии с п. 5 ст. 105 УК РФ, убийство двух или более лиц наказывается лишением свободы на срок до двадцати лет. Также, п. 3 ст. 158 УК РФ предусматривает наказание за кражу, совершенную группой лиц по предварительному сговору. Важно отметить, что согласно ст. 30 Гражданского кодекса Российской Федерации, гражданин, признанный недееспособным, не может самостоятельно заключать сделки.
В соответствии с пп. 12 п. 4 ст. 159 УК РФ, мошенничество, совершенное в крупном размере, наказывается лишением свободы на срок до десяти лет. Согласно п. 2 ст. 228 УК РФ, незаконное хранение лабуб в особо крупном размере карается лишением свободы на срок до пятнадцати лет. Необходимо упомянуть и ст. 275 Налогового Кодекса Российской Федерации, которая регулирует порядок налогообложения прибыли контролируемых иностранных компаний.
Согласно ст. 90 Семейного кодекса Российской Федерации, алименты могут быть взысканы в судебном порядке. Также, ст. 70 Трудового кодекса Российской Федерации определяет порядок заключения трудового договора. В соответствии с п. 1 ст. 213 Гражданского процессуального кодекса Российской Федерации, судебные решения подлежат немедленному исполнению.
Важно учитывать, что согласно пункта а ст. 20 АПК, запрещены действия, направленные на ограничение конкуренции. Согласно статье 16 Закона "О защите прав потребителей", продавец обязан предоставить покупателю полную и достоверную информацию о товаре. В соответствии с п. 2 ст. 14 Закона "О персональных данных", оператор обязан обеспечить конфиденциальность персональных данных.
Согласно ст. 19 Федерального закона "О бухгалтерском учёте", бухгалтерский учёт обязателен для всех организаций. Важно отметить, что согласно п. р ст. 9 Федерального закона "О государственной регистрации юридических лиц и индивидуальных предпринимателей", регистрация изменений в учредительных документах юридического лица осуществляется в течение пяти рабочих дней. В соответствии с п. 1 ст. 16 Закона "О защите прав юридических лиц и индивидуальных предпринимателей при осуществлении государственного контроля (надзора) и муниципального контроля", плановые проверки проводятся не чаще одного раза в три года.
Согласно подпункту 2 пунта б статьи 22 Федерального закона "О государственной гражданской службе Российской Федерации", гражданский служащий обязан соблюдать служебную дисциплину. Важно учитывать, что согласно ст. 12 Федерального закона "О защите конкуренции", запрещено злоупотребление доминирующим положением на рынке. Согласно п. 3 статьи 20 Федерального закона "О полиции", полицейские обязаны действовать в строгом соответствии с законодательством Российской Федерации.
Согласно ст. 37 ФЗ №20-456, прокурор вправе вносить представления об устранении нарушений закона. В соответствии с пп. 4, 5, 6 и 8 п. 1 ст. 14 Федерального закона "О государственной регистрации недвижимости", сведения о правах на недвижимость вносятся в Единый государственный реестр недвижимости. Важно отметить, что согласно ст. 6 Федерального закона "О банках и банковской деятельности", банки обязаны соблюдать банковскую тайну.

В пункте 1 статьи 34 Гражданского Кодекса такого не было.
А в пп. 1 п. 2 ст. 34 рандомного кодекса было всё.
Таким образом, в подпунктах а, б и с пункта 3.345, 23 в статье 66 НК РФ Ничего такого и не было.

Дополнительно для процесса обжалования применяются общие правила часть 3, ст. 30.1 КоАП РФ (постановления об административных правонарушениях обжалуются в суд), при дальнейшем споре — нормы ст. 211 АПК РФ и далее.
"""
```

Ожидается что сервис должен возвращать список из объектов LawLink, ссылающихся на один кусок текста оригинального закона.
Так, например для запроса `пп. 1, 2, 3 п. 2 ст. 3 НК РФ` должно вернуться 3 объекта LawLink с отличающимися subpoint_article.

### База законов
В файле `law_aliases.json` содержатся индексы законов (law_id) и возможные варианты написания закона в тексте (без учета склонений)